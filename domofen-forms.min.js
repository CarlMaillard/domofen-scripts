!function(e){"use strict";const t={PREFILL_URL:"https://hook.eu2.make.com/ot2avkdhia8huotzr9a1977n7424e544",SAVE_DRAFT_URL:"https://hook.eu2.make.com/2hico86g34x5fqfq7i1ytn5y067ku4ov",BTN_ADD_SELECTOR:"#btn-add-position",BTN_ADD_TEXT_PATTERNS:["position supplémentaire","ajouter une position","créer une position","add position"],BTN_CLOSE_SELECTOR:".close_button_image",FORM_SELECTORS:["form#Demande_offre","form#Passer_commande","form#modifier_offre",'form[name="wf-form-Demande_offre"]','form[name="wf-form-Passer_commande"]','form[name="wf-form-modifier_offre"]','form[aria-label="Demande_offre"]','form[aria-label="Passer_commande"]','form[aria-label="modifier_offre"]',"form"],COLOR_KEYS:["couleur_interieur","couleur_exterieur","couleur_intercalaire","couleur_ame_profil"],RADIO_GROUP_CANDIDATES:["question_adresse_livraison_differente","question_autre_adresse_livraison","question-adresse-livraison","question-adresse-livraison-differente","autre-adresse-livraison","autre_adresse_livraison"]},n=(e,t=document)=>t.querySelector(e),r=(e,t=document)=>Array.from(t.querySelectorAll(e));function o(e){if(null==e)return"";try{return String(e).normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim()}catch{return String(e).toLowerCase().trim()}}function i(e,t,n){let r=e.querySelector('[name="'+t+'"]');return r||(r=document.createElement("input"),r.type="hidden",r.name=t,e.appendChild(r)),r.value=null==n?"":String(n),r}function s(e,t){let n=e.querySelector('input[type="hidden"][name="'+t+'"]');return n||(n=document.createElement("input"),n.type="hidden",n.name=t,e.appendChild(n)),n}function a(e){try{const t="radio"===e.type,n="checkbox"===e.type;if(!t&&!n)return;const r=e.closest(t?".w-radio":".w-checkbox"),o=r&&r.querySelector(".w-radio-input, .w-form-formradioinput, .w-checkbox-input");o&&(e.checked?o.classList.add("w--redirected-checked"):o.classList.remove("w--redirected-checked")),r&&r.setAttribute("aria-checked",e.checked?"true":"false")}catch(e){}}const l={init(){const e=()=>t.COLOR_KEYS.forEach(e=>this.populate(e));"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e(),document.body.addEventListener("position:added",e=>{const n=e.detail?.container||document;t.COLOR_KEYS.forEach(e=>{n.querySelector(`select[name="${e}"]`)&&this.populate(e)})})},populate(e){const t=n(`select[name="${e}"]`);if(!t)return;const o=t.value,i=t.querySelector('option[value=""]'),s=r(`.cms-select-source[data-for="${e}"]`).map(e=>(e.getAttribute("data-label")||"").trim()).filter(Boolean);t.innerHTML="",t.appendChild(i||this.makeOption("","Faites votre choix")),s.forEach(e=>t.appendChild(this.makeOption(e,e))),o&&(t.value=o,t.dispatchEvent(new Event("change",{bubbles:!0})))},makeOption(e,t){const n=document.createElement("option");return n.value=e,n.textContent=t,n}},c={init(){const e=(e,t)=>{const r=n(e),o=n(`input[name="${t}"]`);r&&o&&r.textContent.trim()&&(o.value=r.textContent.trim())},t=()=>{e("#ms_email_txt","ms_email"),e("#ms_first_txt","ms_first_name"),e("#ms_last_txt","ms_last_name"),e("#ms_company_txt","ms_company"),e("#ms_adresse_txt","ms_adresse")};document.addEventListener("DOMContentLoaded",()=>{t(),setTimeout(t,300)})}},d={init(){const e=this.detectGroupName();if(!e)return;const t=[n('.autre-wrap[data-for="autre_adresse_de_livraison"]'),n('.autre-wrap[data-for="autre_adress_npa"]'),n('.autre-wrap[data-for="autre_adress_localite"]')].filter(Boolean);if(!t.length)return;const r=t.map(e=>e.querySelector("input, textarea, select")).filter(Boolean),o=new Set(["1","oui","yes","true","vrai","on"]);let i=!1,s=null,a=!1;const l=()=>{const l=n(`input[type="radio"][name="${e}"]:checked`),c=l&&o.has(String(l.value||"").toLowerCase().trim());t.forEach(e=>{e.hidden=!c}),r.forEach(e=>{e.required=c}),i&&!0===s&&!1===c&&a&&r.forEach(e=>{e&&e.value&&(e.value=""),!e||"checkbox"!==e.type&&"radio"!==e.type||(e.checked=!1)}),s=c};document.addEventListener("change",t=>{t.target&&t.target.matches(`input[type="radio"][name="${e}"]`)&&(a=!0,l())},!0);const c=()=>{l(),setTimeout(l,120),setTimeout(l,400),i=!0};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",c,{once:!0}):c(),document.addEventListener("prefill:applied",()=>l()),document.addEventListener("domofen:rec-updated",()=>l())},detectGroupName(){for(const e of t.RADIO_GROUP_CANDIDATES)if(n(`input[type="radio"][name="${e}"]`))return e;return null}},u={currentPicker:null,init(){const e=n(".schema-modal");if(!e)return;const t=e=>{const t=e.getAttribute("data-pos")||"";let n=e.querySelector('input[type="hidden"][name$="__schema_id"]');n||(n=document.createElement("input"),n.type="hidden",n.name=`pos_${t}__schema_id`,n.className="hidden_field hidden-field",e.appendChild(n));let r=e.querySelector('input[type="hidden"][name$="__schema_url"]');return r||(r=document.createElement("input"),r.type="hidden",r.name=`pos_${t}__schema_url`,r.className="hidden_field hidden-field",e.appendChild(r)),{hidId:n,hidUrl:r}},o=t=>{this.currentPicker=t,e.setAttribute("data-open","1"),e.style.display="block"},i=()=>{e.removeAttribute("data-open"),e.style.display="none",this.currentPicker=null};document.addEventListener("click",n=>{if(n.target.closest(".schema-thumb")){const e=n.target.closest(".schema-picker");return void(e&&o(e))}const r=n.target.closest(".schema-card");if(r&&e.contains(r)){if(!this.currentPicker)return;const e=r.getAttribute("data-schema-id")||r.dataset.schemaId||"",n=r.querySelector("img"),o=n?n.currentSrc||n.src||(n.getAttribute("srcset")||"").split(" ")[0]||n.getAttribute("data-src"):"",s=this.currentPicker.querySelector("img.schema-thumb-img"),a=this.currentPicker.querySelector(".schema-plus");s&&o&&(s.src=o,s.style.opacity="1"),a&&(a.style.opacity="0");const{hidId:l,hidUrl:c}=t(this.currentPicker);return l&&(l.value=e),c&&(c.value=o||""),void i()}(n.target.closest(".schema-close")||n.target===e)&&i()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&"1"===e.getAttribute("data-open")&&i()}),document.addEventListener("DOMContentLoaded",()=>{r(".schema-picker").forEach(e=>{t(e);const n=e.querySelector("img.schema-thumb-img"),r=e.querySelector(".schema-plus"),o=e.querySelector('input[type="hidden"][name$="__schema_id"]');if(n&&o&&o.value){const t=e.getAttribute("data-thumb-url");if(t){n.src=t,n.style.opacity="1",r&&(r.style.opacity="0");const o=e.querySelector('input[type="hidden"][name$="__schema_url"]');o&&!o.value&&(o.value=t)}}})}),document.addEventListener("submit",e=>{const n=e.target;n instanceof HTMLFormElement&&n.querySelectorAll(".schema-picker").forEach(e=>{const{hidUrl:n}=t(e);if(n&&!n.value){const t=e.querySelector("img.schema-thumb-img"),r=t&&(t.currentSrc||t.src||"");r&&(n.value=r)}})})}},m={AUTRE_VAL:"__autre__",init(){const e=e=>{if(!e||e.dataset.autreWired)return;if(t.COLOR_KEYS.includes(e.name))return;e.dataset.autreWired="1";const n=e.dataset.key,r=(e.closest(".js-position")||document).querySelector(`.autre-wrap[data-for="${n}"]`);if(!r)return;[...e.options].some(e=>e.value===this.AUTRE_VAL)||e.add(new Option("Autre (préciser)…",this.AUTRE_VAL));const o=r.querySelector("input"),i=()=>{const t=e.value===this.AUTRE_VAL;r.hidden=!t,o&&(o.required=t,t||(o.value=""))};e.addEventListener("change",i),i()},n=(t=document)=>t.querySelectorAll("select[data-key]").forEach(t=>e(t));document.addEventListener("DOMContentLoaded",()=>n()),document.body.addEventListener("position:added",e=>n(e.detail.container))}},h={RE_DOUBLE:/pos_(\d+)__/g,RE_SINGLE:/pos_(\d+)_/g,init(){document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>this.onAddClick(e)),document.addEventListener("click",e=>this.onCloseClick(e)),this.updateCloseButtons()})},lastPositionEl(){const e=document.querySelectorAll(".js-position");return e.length?e[e.length-1]:null},nextPosNumber(){const e=this.lastPositionEl();return e?parseInt(e.dataset.pos,10)+1:1},replacePosStr(e,t){return e.replace(this.RE_DOUBLE,`pos_${t}__`).replace(this.RE_SINGLE,`pos_${t}_`)},updateCloseButtons(){r(".js-position").forEach((e,n)=>{const r=e.querySelector(t.BTN_CLOSE_SELECTOR);r&&(0===n?(r.style.display="none",r.setAttribute("aria-hidden","true"),r.tabIndex=-1):(r.style.display="",r.removeAttribute("aria-hidden"),r.tabIndex=0))})},retag(e,t){e.dataset.pos=String(t),e.querySelectorAll("[data-pos]").forEach(e=>e.dataset.pos=String(t)),e.querySelectorAll("input, select, textarea, label, [data-name]").forEach(e=>{e.name&&(e.name=this.replacePosStr(e.name,t)),e.id&&(e.id=this.replacePosStr(e.id,t)),"LABEL"===e.tagName&&e.htmlFor&&(e.htmlFor=this.replacePosStr(e.htmlFor,t)),e.hasAttribute("data-name")&&e.setAttribute("data-name",this.replacePosStr(e.getAttribute("data-name"),t))});let n=e.querySelector('input[name^="pos_"][name$="__index"]');n?(n.name=`pos_${t}__index`,n.value=String(t),n.id=`pos_${t}__index`):(n=document.createElement("input"),n.type="hidden",n.name=`pos_${t}__index`,n.value=String(t),n.className="input_hidden",e.appendChild(n));const r=e.querySelector(".position-title-name, h3.heading-style-h3");r&&(r.textContent=`Position ${t}`)},resetValues(e){e.querySelectorAll("input, select, textarea").forEach(e=>{if("radio"===e.type||"checkbox"===e.type){e.checked=!1;const t=e.closest(".w-radio")?.querySelector(".w-radio-input, .w-form-formradioinput"),n=e.closest(".w-checkbox")?.querySelector(".w-checkbox-input");t&&t.classList.remove("w--redirected-checked"),n&&n.classList.remove("w--redirected-checked");const r=e.closest(".w-radio, .w-checkbox");r&&r.setAttribute("aria-checked","false")}else"SELECT"===e.tagName?e.selectedIndex=0:e.value=""}),e.querySelectorAll(".autre-wrap").forEach(e=>e.hidden=!0),e.querySelectorAll("select[data-key]").forEach(e=>{e.removeAttribute("data-autre-wired"),delete e.dataset.autreWired}),e.querySelectorAll(".schema-thumb-img").forEach(e=>e.removeAttribute("src")),e.querySelectorAll(".schema-plus").forEach(e=>e.style.opacity="1");const t=e.querySelector('input[name$="__schema_id"]');t&&(t.value=""),e.querySelectorAll("select[data-key]").forEach(e=>{e.dispatchEvent(new Event("change",{bubbles:!0}))})},reindexAll(){r(".js-position").forEach((e,t)=>this.retag(e,t+1)),this.updateCloseButtons(),window.Webflow&&window.Webflow.destroy(),window.Webflow&&window.Webflow.ready(),window.Webflow&&window.Webflow.require("ix2").init()},onAddClick(e){let n=e.target.closest(t.BTN_ADD_SELECTOR);if(!n){const r=e.target.closest('button, a, [role="button"], input[type="button"]');if(r){const e=(r.textContent||r.value||"").toLowerCase();t.BTN_ADD_TEXT_PATTERNS.some(t=>e.includes(t.toLowerCase()))&&(n=r)}}if(!n)return;e.preventDefault();const r=this.lastPositionEl();if(!r)return;const o=this.nextPosNumber(),i=r.cloneNode(!0);this.retag(i,o),this.resetValues(i),r.after(i),document.body.dispatchEvent(new CustomEvent("position:added",{detail:{container:i}})),this.reindexAll(),i.scrollIntoView({behavior:"smooth",block:"start"})},onCloseClick(e){const n=e.target.closest(t.BTN_CLOSE_SELECTOR);if(!n)return;const r=n.closest(".js-position");if(!r)return;const o=parseInt(r.dataset.pos||"0",10)||0;confirm(`Supprimer la position ${o} ?`)&&(r.remove(),document.body.dispatchEvent(new CustomEvent("position:removed",{detail:{removedIndex:o}})),this.reindexAll())}},_={init(){const e=()=>document.addEventListener("submit",e=>this.handleSubmit(e),!0);"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()},readField:e=>e&&e.name?"checkbox"===e.type?{name:e.name,value:!!e.checked}:"radio"===e.type?e.checked?{name:e.name,value:e.value}:null:{name:e.name,value:e.value}:null,serializePosition(e){const t=Number(e.dataset.pos||"0")||0,n=/^pos_\d+__/,r={index:t};e.querySelectorAll("input, select, textarea").forEach(e=>{const t=this.readField(e);if(!t)return;const o=t.name.replace(n,"");r[o]=t.value});const o=e.querySelector('input[name$="__schema_id"]')?.value||"",i=e.querySelector('input[name$="__schema_url"]')?.value||"";return r.schema={id:o,url:i},r},handleSubmit(e){const t=e.target;try{if(!t||"FORM"!==t.tagName)return;const e=t.querySelectorAll(".js-position");if(!e.length)return;const n=Array.from(e).map(e=>this.serializePosition(e)).sort((e,t)=>(e.index||0)-(t.index||0));s(t,"positions_json").value=JSON.stringify(n),s(t,"positions_count").value=String(n.length)}catch(e){console.error("[positions_json] serialization error:",e)}}},p={form:null,flow:"demande",init(e,t){this.form=e,this.flow=t;const n=new URLSearchParams(location.search||""),r=n.has("rec"),o=n.has("item");r&&sessionStorage.setItem("domofen_rec_fallback_ok","1");let s="1"===sessionStorage.getItem("domofen_rec_fallback_ok");"commande"!==t||r||(this.purgeSessionKeys(),s=!1);const a=r?n.get("rec"):s&&sessionStorage.getItem("domofen_rec")||"",l=o?n.get("item"):s&&sessionStorage.getItem("domofen_item")||"";r&&sessionStorage.setItem("domofen_rec",a),o&&sessionStorage.setItem("domofen_item",l),sessionStorage.setItem("domofen_flow",t),i(e,"airtable_record_id",a),i(e,"webflow_item_id",l),i(e,"workflow_action",t),e.dataset.mode=a?"update":"new",e.dataset.flow=t;try{const n=e.querySelector('[type="submit"], .w-button[type="submit"]');n&&(n.textContent="commande"===t?"Commander":"Envoyer ma demande")}catch(e){}this.initHydration(),this.withMemberId(e=>{a&&this.runPrefill(a,e)})},purgeSessionKeys(){sessionStorage.removeItem("domofen_rec"),sessionStorage.removeItem("domofen_item"),sessionStorage.removeItem("domofen_rec_fallback_ok")},withMemberId(e){window.$memberstackDom&&$memberstackDom.getCurrentMember?$memberstackDom.getCurrentMember().then(t=>{const n=t?.data?.id||"";n&&sessionStorage.setItem("domofen_msid",n),e(n)}).catch(()=>this.fallbackV1(e)):this.fallbackV1(e)},fallbackV1(e){window.MemberStack&&window.MemberStack.onReady?window.MemberStack.onReady.then(t=>{const n=t?.member?.id||"";n&&sessionStorage.setItem("domofen_msid",n),e(n)}).catch(()=>e("")):e("")},runPrefill(e,n){i(this.form,"member_stack_id",n||""),fetch(t.PREFILL_URL+"?rec="+encodeURIComponent(e),{method:"GET",headers:{"x-member-id":n||""}}).then(e=>{if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(e=>this.applyPrefillToForm(e)).catch(e=>console.error("[Prefill] fetch error",e))},applyPrefillToForm(e){const t=e&&"object"==typeof e.fields?e.fields:{};Object.keys(t).forEach(e=>{const n=this.form.querySelector('[name="'+e+'"]');if(!n)return;const r=t[e];if("checkbox"===n.type)this.setCheckbox(n,r);else if("radio"===n.type)this.setRadio(e,r);else if("SELECT"===n.tagName){let e=!1;if(n.querySelector('option[value="'+r+'"]')&&(n.value=String(r),e=!0),!e){const t=Array.from(n.options).find(e=>o(e.textContent)===o(r));t&&(n.value=t.value,e=!0)}e||(n.value=String(r)),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0}))}else{if(null!=r&&"object"==typeof r)try{n.value=JSON.stringify(r)}catch(e){n.value=String(r)}else n.value=r??"";n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0}))}});try{const e=t.positions_json;if(e){const t="string"==typeof e?JSON.parse(e):e;Array.isArray(t)&&window.__domofenHydratePositions&&window.__domofenHydratePositions(this.form,t)}if(void 0!==t.positions_count){const e=this.form.querySelector('[name="positions_count"]');e&&(e.value=String(t.positions_count))}}catch(e){console.warn("[Prefill] positions_json parse error",e)}this.form.querySelectorAll('input[type="radio"]:checked').forEach(e=>{e.dispatchEvent(new Event("change",{bubbles:!0}))});const n=()=>{this.form.querySelectorAll('input[type="checkbox"]').forEach(e=>{const t=e.closest(".w-checkbox")?.querySelector(".w-checkbox-input");t&&(e.checked?t.classList.add("w--redirected-checked"):t.classList.remove("w--redirected-checked"));const n=e.closest(".w-checkbox");n&&n.setAttribute("aria-checked",e.checked?"true":"false")})};n(),setTimeout(n,50),setTimeout(n,150),setTimeout(n,300),document.dispatchEvent(new CustomEvent("prefill:applied",{detail:{fields:t}})),window.__domofen_last_fields=t},setCheckbox(e,t){const n=function(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e||"1"===e)return!0;if(0===e||"0"===e)return!1;const t=String(e).toLowerCase().trim();return!["","false","non","no","off","null","undefined","n"].includes(t)&&(!!["true","oui","yes","on","vrai","y","checked"].includes(t)||t.length>0)}(t);e.checked=n,a(e),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))},setRadio(e,t){const n=Array.from(this.form.querySelectorAll('input[type="radio"][name="'+e+'"]'));if(!n.length)return!1;const r=o(null==t?"":String(t)),i=new Set(["1","true","oui","yes","vrai","on"]),s=new Set(["0","false","non","no","off","faux"]),l=()=>n.forEach(e=>{e.checked=!1,a(e)}),c=e=>(e.checked=!0,a(e),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),!0);let d=n.find(e=>o(e.value)===r);return d?(l(),c(d)):(d=n.find(e=>{const t=e.closest(".w-radio")?.querySelector("label");return t&&o(t.textContent)===r}),(d||!(!i.has(r)&&!s.has(r)||(d=n.find(e=>i.has(r)?i.has(o(e.value)):s.has(o(e.value))),d||(d=n.find(e=>{const t=e.closest(".w-radio")?.querySelector("label"),n=t?o(t.textContent):"";return i.has(r)?n.includes("oui")||i.has(n):n.includes("non")||s.has(n)})),!d)))&&(l(),c(d)))},initHydration(){const e=(e,t,n)=>{const r=e.querySelector('[name="'+t+'"]');if(!r)return!1;if("checkbox"===r.type)this.setCheckbox(r,n);else if("radio"===r.type)this.setRadio(t,n);else if("SELECT"===r.tagName){let e=!1;if(r.querySelector('option[value="'+n+'"]')&&(r.value=String(n),e=!0),!e){const t=Array.from(r.options).find(e=>o(e.textContent)===o(n));t&&(r.value=t.value,e=!0)}e||(r.value=String(n)),r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}else r.value=null!=n&&"object"==typeof n?JSON.stringify(n):n??"",r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}));return!0},t=()=>document.querySelectorAll(".js-position").length;window.__domofenHydratePositions=(r,o)=>{if(!Array.isArray(o)||0===o.length)return;const i=n("#btn-add-position");for(;t()<o.length&&i;)i.click();for(;t()>o.length;){const e=document.querySelectorAll(".js-position"),t=e[e.length-1];t&&t.remove()}o.sort((e,t)=>(e.index||0)-(t.index||0)).forEach((t,n)=>{const o=n+1,i=document.querySelector('.js-position[data-pos="'+o+'"]')||(()=>{const e=document.querySelectorAll(".js-position");return e.length?e[e.length-1]:null})();if(!i)return;Object.keys(t).forEach(n=>{"index"!==n&&"schema"!==n&&e(r,"pos_"+o+"__"+n,t[n])});const s=t.schema?.id||"",a=t.schema?.url||"";if(e(r,"pos_"+o+"__schema_id",s),e(r,"pos_"+o+"__schema_url",a),a){const e=i.querySelector("img.schema-thumb-img"),t=i.querySelector(".schema-plus");e&&(e.src=a,e.style.opacity="1"),t&&(t.style.opacity="0")}});const s=r.querySelector('[name="positions_json"]'),a=r.querySelector('[name="positions_count"]');s&&(s.value=JSON.stringify(o)),a&&(a.value=String(o.length))}}},f={form:null,init(e){this.form=e;const t=()=>{const e=this.findDraftButton();e?("A"===e.tagName&&(e.setAttribute("href","#"),e.setAttribute("role","button")),e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.save(e)}),console.log("[Draft] ready")):console.warn("[Draft] bouton introuvable")};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()},findDraftButton:()=>n("#btn-save-draft")||n('[data-action="save-draft"]')||Array.from(document.querySelectorAll("a,button")).find(e=>/enregistrer le brouillon/i.test(e.textContent||"")),valAny(e){for(const t of e){const e=this.form.querySelector('[name="'+t+'"]');if(e){if("radio"===e.type){const e=this.form.querySelector('input[type="radio"][name="'+t+'"]:checked');if(e)return e.value;continue}if("checkbox"===e.type)return e.checked?"true":"false";if(void 0!==e.value&&""!==e.value)return e.value}}return""},get(e){const t=this.form.querySelector('[name="'+e+'"]');return t?t.value:""},getTextContent(e){const t=document.querySelector(e);return t?(t.textContent||"").trim():""},ensurePositionsSerialized(){const e=this.form.noValidate,t=this.form.hasAttribute("novalidate");this.form.noValidate=!0,t||this.form.setAttribute("novalidate","");try{const e=new Event("submit",{bubbles:!0,cancelable:!0});this.form.dispatchEvent(e)}catch(e){}return this.form.noValidate=e,t||this.form.removeAttribute("novalidate"),{positions_json:this.get("positions_json")||"",positions_count:this.get("positions_count")||""}},rewriteUrlWithRec(e){try{if(!e)return;const t=new URL(location.href);t.searchParams.get("rec")!==String(e)&&(t.searchParams.set("rec",String(e)),history.replaceState(null,"",t.toString()));let n=this.form.querySelector('[name="airtable_record_id"]');n||(n=document.createElement("input"),n.type="hidden",n.name="airtable_record_id",this.form.appendChild(n)),n.value=String(e),sessionStorage.setItem("domofen_rec",String(e)),this.form.dataset.mode="update"}catch(e){console.warn("[Draft] rewriteUrlWithRec error",e)}},buildPayload(){const e=new URLSearchParams(location.search||""),t=this.form.id||this.form.getAttribute("name")||"",n=e.get("flow")||this.get("workflow_action")||"demande",r=this.valAny(["airtable_record_id","record_id"])||e.get("rec")||"",o=this.valAny(["webflow_item_id","webflow-id","webflow_item","webflowId"])||e.get("item")||"",i=this.valAny(["member_stack_id","memberstack_id"])||sessionStorage.getItem("domofen_msid")||"",s=this.ensurePositionsSerialized(),a=s.positions_json||"",l=s.positions_count||"";let c=[];try{c=a?JSON.parse(a):[]}catch(e){}return{action:"draft",etat:"Brouillon",form_id:t,workflow_action:n,airtable_record_id:r,webflow_item_id:o,member_stack_id:i,rec:r,item:o,positions_json:a,positions_count:l,positions:c,meta:{form_id:t,submitted_at:"",offer_or_demand:"",form_id:"",submission_id:"",page_id:"",page_url:location.href||"",published_path:""},memberstack:{email:this.valAny(["ms_email"])||this.getTextContent("#ms_email_txt"),first_name:this.valAny(["ms_first_name"])||this.getTextContent("#ms_first_txt"),last_name:this.valAny(["ms_last_name"])||this.getTextContent("#ms_last_txt"),company:this.valAny(["ms_company"])||this.getTextContent("#ms_company_txt"),adresse:this.valAny(["ms_adresse"])||this.getTextContent("#ms_adresse_txt")},entreprise:{responsable_du_dossier:this.valAny(["responsable-du-dossier","responsable_du_dossier"]),adresse_email_de_retour:this.valAny(["email-adresse-de-retour","Email-retour-different"]),question_adresse_livraison_differente:this.valAny(["question_adresse_livraison_differente","autre-adresse-livraison","autre-adresse-livraison?","autre_adresse_livraison"]),autre_adresse_livraison:this.valAny(["autre_adresse_de_livraison","autre_adresse_livraison"]),autre_adress_npa:this.valAny(["autre_adress_npa"]),autre_adress_localite:this.valAny(["autre_adress_localite"])},chantier:{reference:this.valAny(["Reference","ref_demande"]),type_chantier:this.valAny(["Type de chantier","Type-de-chantier"]),type_bien:this.valAny(["Type de bien","Type-de-bien"]),adresse_chantier:this.valAny(["Adress_chantier","Adresse chantier","Adresse chantier*","Adresse de livraison"]),npa:this.valAny(["NPA"]),localite:this.valAny(["Localité","Localit","chantier_localite"])},choix:{couleur_interieur:this.valAny(["couleur_interieur"]),couleur_exterieur:this.valAny(["couleur_exterieur"]),couleur_intercalaire:this.valAny(["couleur_intercalaire"]),couleur_ame_profil:this.valAny(["couleur_ame_profil"]),type_de_soudure:this.valAny(["type de soudure","type-de-soudure"]),verres:this.valAny(["choix-des-verres"]),verres_autre:this.valAny(["vitrage_autre","Vitrage – autre"]),altitude:this.valAny(["Altitude","altitude"]),delignement:this.valAny(["Délignement","D-lignement"]),securite:this.valAny(["securite","Sécurité"]),renvoie_eau:this.valAny(["Renvoie deau","Renvoie-d-eau"]),cale_15x21:this.valAny(["Cale 15x21 mm","Cale-15x21-mm"]),cale_21x15:this.valAny(["Cale 21x15 mm","Cale-21x15-mm"]),donnee_de_dimension:this.valAny(["donnee de dimension","donnee_de_dimension"]),fermente_invisible:this.valAny(["Fermente invisible","Fermente-invisible"]),clip_reno_111033:this.valAny(["Clip Reno 111033","Clip-Reno-111033"])},options:{renvoie_eau:this.valAny(["Renvoie deau","Renvoie-d-eau"]),fixation:this.valAny(["Fixation"]),cale_15x21:this.valAny(["Cale 15x21 mm","Cale-15x21-mm"]),cale_21x15:this.valAny(["Cale 21x15 mm","Cale-21x15-mm"]),donnee_de_dimension:this.valAny(["donnee de dimension","donnee_de_dimension"]),fermente_invisible:this.valAny(["Fermente invisible","Fermente-invisible"]),clip_reno_111033:this.valAny(["Clip Reno 111033","Clip-Reno-111033"])},remarque_general:{remarques:this.valAny(["remarques-generales","Remarques générales"])},pieces_jointes:{domofen_upload:this.valAny(["DomofenOfficiel","Document_upload"])}}},save(e){const n=this.form.querySelector("#Reference")||this.form.querySelector('[name="Reference"]');if(n){if(!(n.value||"").trim())return n.setCustomValidity("Le champ Référence est obligatoire avant de sauvegarder votre brouillon"),n.reportValidity(),void n.addEventListener("input",function e(){n.setCustomValidity(""),n.removeEventListener("input",e)});n.setCustomValidity("")}const r=Array.from(this.form.querySelectorAll("[required]"));r.forEach(e=>e.removeAttribute("required"));const o=this.buildPayload();e.disabled=!0,setTimeout(()=>{r.forEach(e=>e.setAttribute("required",""))},100),fetch(t.SAVE_DRAFT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(async e=>{const t=await e.text();let n={};try{n=t?JSON.parse(t):{}}catch(e){console.warn("[Draft] JSON parse error",t)}return{ok:e.ok,status:e.status,json:n}}).then(({ok:e,json:t})=>{console.log("[Draft] response",t);const n=t&&(t.rec||t.record_id||t.airtable_record_id);n&&this.rewriteUrlWithRec(String(n)),alert(e?"Brouillon enregistré.":"Impossible d'enregistrer le brouillon.")}).catch(e=>{console.error("[Draft] error",e),alert("Impossible d'enregistrer le brouillon pour le moment.")}).finally(()=>{e.disabled=!1})}},y={init(e){if(!e)return;const t=t=>{let n=e.querySelector('input[type="hidden"][name="'+t+'"]');return n||(n=document.createElement("input"),n.type="hidden",n.name=t,e.appendChild(n)),n},n=e.querySelector('input[name="autre_adresse_de_livraison"]'),r=e.querySelector('input[name="autre_adress_npa"]'),o=e.querySelector('input[name="autre_adress_localite"]'),i=t("autre_adresse_de_livraison_mirror"),s=t("autre_adress_npa_mirror"),a=t("autre_adress_localite_mirror"),l=(e,t)=>{e&&(t.value=e.value||"")},c=()=>{l(n,i),l(r,s),l(o,a)};[n,r,o].forEach(e=>{e&&(e.addEventListener("input",c),e.addEventListener("change",c))}),document.addEventListener("prefill:applied",c),document.addEventListener("DOMContentLoaded",c),e.addEventListener("submit",c,!0)}},v={init(e={}){const r=e.flow||"demande";l.init(),c.init(),d.init(),u.init(),m.init(),h.init(),_.init();const o=function(){for(const e of t.FORM_SELECTORS){const t=n(e);if(t)return t}return null}();o?(p.init(o,r),f.init(o),y.init(o),console.log("[DomofenForms] initialized with flow:",r)):console.error("[DomofenForms] Form not found")}};e.DomofenForms=v}("undefined"!=typeof window?window:this);
