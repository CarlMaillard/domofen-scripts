!function(e){"use strict";let t={PREFILL_URL:"https://hook.eu2.make.com/ot2avkdhia8huotzr9a1977n7424e544",SAVE_DRAFT_URL:"https://hook.eu2.make.com/2hico86g34x5fqfq7i1ytn5y067ku4ov",BTN_ADD_SELECTOR:"#btn-add-position",BTN_ADD_TEXT_PATTERNS:["position suppl\xe9mentaire","ajouter une position","cr\xe9er une position","add position"],BTN_CLOSE_SELECTOR:".close_button_image",FORM_SELECTORS:["form#Demande_offre","form#Passer_commande","form#modifier_offre",'form[name="wf-form-Demande_offre"]','form[name="wf-form-Passer_commande"]','form[name="wf-form-modifier_offre"]','form[aria-label="Demande_offre"]','form[aria-label="Passer_commande"]','form[aria-label="modifier_offre"]',"form"],COLOR_KEYS:["couleur_interieur","couleur_exterieur","couleur_intercalaire","couleur_ame_profil"],RADIO_GROUP_CANDIDATES:["question_adresse_livraison_differente","question_autre_adresse_livraison","question-adresse-livraison","question-adresse-livraison-differente","autre-adresse-livraison","autre_adresse_livraison"]},r=(e,t=document)=>t.querySelector(e),i=(e,t=document)=>Array.from(t.querySelectorAll(e));function a(e){if(null==e)return"";try{return String(e).normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim()}catch{return String(e).toLowerCase().trim()}}function n(e,t,r){let i=e.querySelector('[name="'+t+'"]');return i||((i=document.createElement("input")).type="hidden",i.name=t,e.appendChild(i)),i.value=null==r?"":String(r),i}function o(e,t){let r=e.querySelector('input[type="hidden"][name="'+t+'"]');return r||((r=document.createElement("input")).type="hidden",r.name=t,e.appendChild(r)),r}function s(e){try{let t="radio"===e.type,r="checkbox"===e.type;if(!t&&!r)return;let i=e.closest(t?".w-radio":".w-checkbox"),a=i&&i.querySelector(".w-radio-input, .w-form-formradioinput, .w-checkbox-input");a&&(e.checked?a.classList.add("w--redirected-checked"):a.classList.remove("w--redirected-checked")),i&&i.setAttribute("aria-checked",e.checked?"true":"false")}catch(n){}}let l={init(){let e=()=>t.COLOR_KEYS.forEach(e=>this.populate(e));"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e(),document.body.addEventListener("position:added",e=>{let r=e.detail?.container||document;t.COLOR_KEYS.forEach(e=>{r.querySelector(`select[name="${e}"]`)&&this.populate(e)})})},populate(e){let t=r(`select[name="${e}"]`);if(!t)return;let a=t.value,n=t.querySelector('option[value=""]'),o=i(`.cms-select-source[data-for="${e}"]`).map(e=>(e.getAttribute("data-label")||"").trim()).filter(Boolean);t.innerHTML="",t.appendChild(n||this.makeOption("","Faites votre choix")),o.forEach(e=>t.appendChild(this.makeOption(e,e)));let s=a;if("couleur_intercalaire"===e&&!a){let l=Array.from(t.options).find(e=>"noir"===e.value.toLowerCase());l&&(s=l.value)}s&&(t.value=s,t.dispatchEvent(new Event("change",{bubbles:!0})))},makeOption(e,t){let r=document.createElement("option");return r.value=e,r.textContent=t,r}},d={init(){let e=(e,t)=>{let i=r(`#${e}_txt`),a=r(`input[name="${t}"]`);i&&a&&i.textContent.trim()&&(a.value=i.textContent.trim())},t=()=>{e("ms_email","ms_email"),e("ms_first","ms_first_name"),e("ms_last","ms_last_name"),e("ms_company","ms_company"),e("ms_adresse","ms_adresse")};document.addEventListener("DOMContentLoaded",()=>{t(),setTimeout(t,300)})}},c={init(){let e=this.detectGroupName();if(!e)return;let t=[r('.autre-wrap[data-for="autre_adresse_de_livraison"]'),r('.autre-wrap[data-for="autre_adress_npa"]'),r('.autre-wrap[data-for="autre_adress_localite"]')].filter(Boolean);if(!t.length)return;let i=t.map(e=>e.querySelector("input, textarea, select")).filter(Boolean),a=new Set(["1","oui","yes","true","vrai","on"]),n=!1,o=null,s=!1,l=()=>{let l=r(`input[type="radio"][name="${e}"]:checked`),d=l&&a.has(String(l.value||"").toLowerCase().trim());t.forEach(e=>{e.hidden=!d}),i.forEach(e=>{e.required=d}),n&&!0===o&&!1===d&&s&&i.forEach(e=>{e&&e.value&&(e.value=""),e&&("checkbox"===e.type||"radio"===e.type)&&(e.checked=!1)}),o=d};document.addEventListener("change",t=>{t.target&&t.target.matches(`input[type="radio"][name="${e}"]`)&&(s=!0,l())},!0);let d=()=>{l(),setTimeout(l,120),setTimeout(l,400),n=!0};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",d,{once:!0}):d(),document.addEventListener("prefill:applied",()=>l()),document.addEventListener("domofen:rec-updated",()=>l())},detectGroupName(){for(let e of t.RADIO_GROUP_CANDIDATES)if(r(`input[type="radio"][name="${e}"]`))return e;return null}},u={currentPicker:null,init(){let e=r(".schema-modal");if(!e)return;let t=e=>{let t=e.getAttribute("data-pos")||"",r=e.querySelector('input[type="hidden"][name$="__schema_id"]');r||((r=document.createElement("input")).type="hidden",r.name=`pos_${t}__schema_id`,r.className="hidden_field hidden-field",e.appendChild(r));let i=e.querySelector('input[type="hidden"][name$="__schema_url"]');return i||((i=document.createElement("input")).type="hidden",i.name=`pos_${t}__schema_url`,i.className="hidden_field hidden-field",e.appendChild(i)),{hidId:r,hidUrl:i}},a=t=>{this.currentPicker=t,e.setAttribute("data-open","1"),e.style.display="block"},n=()=>{e.removeAttribute("data-open"),e.style.display="none",this.currentPicker=null};document.addEventListener("click",r=>{if(r.target.closest(".schema-thumb")){let i=r.target.closest(".schema-picker");if(i){a(i);return}}let o=r.target.closest(".schema-card");if(o&&e.contains(o)){if(!this.currentPicker)return;let s=o.getAttribute("data-schema-id")||o.dataset.schemaId||"",l=o.querySelector("img"),d=l?l.currentSrc||l.src||(l.getAttribute("srcset")||"").split(" ")[0]||l.getAttribute("data-src"):"",c=this.currentPicker.querySelector("img.schema-thumb-img"),u=this.currentPicker.querySelector(".schema-plus");c&&d&&(c.src=d,c.style.opacity="1"),u&&(u.style.opacity="0");let{hidId:m,hidUrl:h}=t(this.currentPicker);m&&(m.value=s),h&&(h.value=d||""),n();return}(r.target.closest(".schema-close")||r.target===e)&&n()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&"1"===e.getAttribute("data-open")&&n()}),document.addEventListener("DOMContentLoaded",()=>{i(".schema-picker").forEach(e=>{t(e);let r=e.querySelector("img.schema-thumb-img"),i=e.querySelector(".schema-plus"),a=e.querySelector('input[type="hidden"][name$="__schema_id"]');if(r&&a&&a.value){let n=e.getAttribute("data-thumb-url");if(n){r.src=n,r.style.opacity="1",i&&(i.style.opacity="0");let o=e.querySelector('input[type="hidden"][name$="__schema_url"]');o&&!o.value&&(o.value=n)}}})}),document.addEventListener("submit",e=>{let r=e.target;r instanceof HTMLFormElement&&r.querySelectorAll(".schema-picker").forEach(e=>{let{hidUrl:r}=t(e);if(r&&!r.value){let i=e.querySelector("img.schema-thumb-img"),a=i&&(i.currentSrc||i.src||"");a&&(r.value=a)}})})}},m={AUTRE_VAL:"__autre__",init(){let e=e=>{if(!e||e.dataset.autreWired||t.COLOR_KEYS.includes(e.name))return;e.dataset.autreWired="1";let r=e.dataset.key,i=(e.closest(".js-position")||document).querySelector(`.autre-wrap[data-for="${r}"]`);if(!i)return;[...e.options].some(e=>e.value===this.AUTRE_VAL)||e.add(new Option("Autre (pr\xe9ciser)…",this.AUTRE_VAL));let a=i.querySelector("input"),n=()=>{let t=e.value===this.AUTRE_VAL;i.hidden=!t,a&&(a.required=t,t||(a.value=""))};e.addEventListener("change",n),n()},r=(t=document)=>{t.querySelectorAll("select[data-key]").forEach(t=>e(t))};document.addEventListener("DOMContentLoaded",()=>r()),document.body.addEventListener("position:added",e=>r(e.detail.container))}},h={RE_DOUBLE:/pos_(\d+)__/g,RE_SINGLE:/pos_(\d+)_/g,init(){document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",e=>this.onAddClick(e)),document.addEventListener("click",e=>this.onCloseClick(e)),this.updateCloseButtons()})},lastPositionEl(){let e=document.querySelectorAll(".js-position");return e.length?e[e.length-1]:null},nextPosNumber(){let e=this.lastPositionEl();return e?parseInt(e.dataset.pos,10)+1:1},replacePosStr(e,t){return e.replace(this.RE_DOUBLE,`pos_${t}__`).replace(this.RE_SINGLE,`pos_${t}_`)},updateCloseButtons(){i(".js-position").forEach((e,r)=>{let i=e.querySelector(t.BTN_CLOSE_SELECTOR);i&&(0===r?(i.style.display="none",i.setAttribute("aria-hidden","true"),i.tabIndex=-1):(i.style.display="",i.removeAttribute("aria-hidden"),i.tabIndex=0))})},retag(e,t){e.dataset.pos=String(t),e.querySelectorAll("[data-pos]").forEach(e=>{e.dataset.pos=String(t)}),e.querySelectorAll("input, select, textarea, label, [data-name]").forEach(e=>{e.name&&(e.name=this.replacePosStr(e.name,t)),e.id&&(e.id=this.replacePosStr(e.id,t)),"LABEL"===e.tagName&&e.htmlFor&&(e.htmlFor=this.replacePosStr(e.htmlFor,t)),e.hasAttribute("data-name")&&e.setAttribute("data-name",this.replacePosStr(e.getAttribute("data-name"),t))});let r=e.querySelector('input[name^="pos_"][name$="__index"]');r?(r.name=`pos_${t}__index`,r.value=String(t),r.id=`pos_${t}__index`):((r=document.createElement("input")).type="hidden",r.name=`pos_${t}__index`,r.value=String(t),r.className="input_hidden",e.appendChild(r));let i=e.querySelector(".position-title-name, h3.heading-style-h3");i&&(i.textContent=`Position ${t}`)},resetValues(e){e.querySelectorAll("input, select, textarea").forEach(e=>{if("radio"===e.type||"checkbox"===e.type){e.checked=!1;let t=e.closest(".w-radio")?.querySelector(".w-radio-input, .w-form-formradioinput"),r=e.closest(".w-checkbox")?.querySelector(".w-checkbox-input");t&&t.classList.remove("w--redirected-checked"),r&&r.classList.remove("w--redirected-checked");let i=e.closest(".w-radio, .w-checkbox");i&&i.setAttribute("aria-checked","false")}else"SELECT"===e.tagName?e.selectedIndex=0:e.value=""}),e.querySelectorAll(".autre-wrap").forEach(e=>e.hidden=!0),e.querySelectorAll("select[data-key]").forEach(e=>{e.removeAttribute("data-autre-wired"),delete e.dataset.autreWired}),e.querySelectorAll(".schema-thumb-img").forEach(e=>e.removeAttribute("src")),e.querySelectorAll(".schema-plus").forEach(e=>e.style.opacity="1");let t=e.querySelector('input[name$="__schema_id"]');t&&(t.value="");let r=e.querySelector('input[name$="__schema_url"]');r&&(r.value=""),e.querySelectorAll("select[data-key]").forEach(e=>{e.dispatchEvent(new Event("change",{bubbles:!0}))})},reindexAll(){i(".js-position").forEach((e,t)=>this.retag(e,t+1)),this.updateCloseButtons(),window.Webflow&&(window.Webflow.destroy(),window.Webflow.ready(),window.Webflow.require("ix2").init())},onAddClick(e){let r=e.target.closest(t.BTN_ADD_SELECTOR);if(!r){let i=e.target.closest('button, a, [role="button"], input[type="button"]');if(i){let a=(i.textContent||i.value||"").toLowerCase();t.BTN_ADD_TEXT_PATTERNS.some(e=>a.includes(e.toLowerCase()))&&(r=i)}}if(!r)return;e.preventDefault();let n=this.lastPositionEl();if(!n)return;let o=this.nextPosNumber(),s=n.cloneNode(!0);this.retag(s,o),this.resetValues(s),n.after(s),document.body.dispatchEvent(new CustomEvent("position:added",{detail:{container:s}})),this.reindexAll(),s.scrollIntoView({behavior:"smooth",block:"start"})},onCloseClick(e){let r=e.target.closest(t.BTN_CLOSE_SELECTOR);if(!r)return;let i=r.closest(".js-position");if(!i)return;let a=parseInt(i.dataset.pos||"0",10)||0;confirm(`Supprimer la position ${a} ?`)&&(i.remove(),document.body.dispatchEvent(new CustomEvent("position:removed",{detail:{removedIndex:a}})),this.reindexAll())}},p={init(){let e=()=>{document.addEventListener("submit",e=>this.handleSubmit(e),!0)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()},readField:e=>e&&e.name?"checkbox"===e.type?{name:e.name,value:!!e.checked}:"radio"===e.type?e.checked?{name:e.name,value:e.value}:null:{name:e.name,value:e.value}:null,serializePosition(e){let t=Number(e.dataset.pos||"0")||0,r=/^pos_\d+__/,i={index:t};e.querySelectorAll("input, select, textarea").forEach(e=>{let t=this.readField(e);if(!t)return;let a=t.name.replace(r,"");i[a]=t.value});let a=e.querySelector('input[name$="__schema_id"]')?.value||"",n=e.querySelector('input[name$="__schema_url"]')?.value||"",o=e.querySelector('input[name$="__schema_name"]')?.value||"";return i.schema={id:a,url:n,name:o},i},handleSubmit(e){let t=e.target;try{if(!t||"FORM"!==t.tagName)return;let r=t.querySelectorAll(".js-position");if(!r.length)return;let i=Array.from(r).map(e=>this.serializePosition(e)).sort((e,t)=>(e.index||0)-(t.index||0));o(t,"positions_json").value=JSON.stringify(i),o(t,"positions_count").value=String(i.length)}catch(a){console.error("[positions_json] serialization error:",a)}}},f={form:null,flow:"demande",init(e,t){this.form=e,this.flow=t;let r=new URLSearchParams(location.search||""),i=r.has("rec"),a=r.has("item");i&&sessionStorage.setItem("domofen_rec_fallback_ok","1");let o="1"===sessionStorage.getItem("domofen_rec_fallback_ok");"commande"!==t||i||(this.purgeSessionKeys(),o=!1);let s=i?r.get("rec"):o&&sessionStorage.getItem("domofen_rec")||"",l=a?r.get("item"):o&&sessionStorage.getItem("domofen_item")||"";i&&sessionStorage.setItem("domofen_rec",s),a&&sessionStorage.setItem("domofen_item",l),sessionStorage.setItem("domofen_flow",t),n(e,"airtable_record_id",s),n(e,"webflow_item_id",l),n(e,"workflow_action",t),e.dataset.mode=s?"update":"new",e.dataset.flow=t;try{let d=e.querySelector('[type="submit"], .w-button[type="submit"]');d&&(d.textContent="commande"===t?"Commander":"Envoyer ma demande")}catch(c){}this.initHydration(),this.withMemberId(e=>{s&&this.runPrefill(s,e)})},purgeSessionKeys(){sessionStorage.removeItem("domofen_rec"),sessionStorage.removeItem("domofen_item"),sessionStorage.removeItem("domofen_rec_fallback_ok")},withMemberId(e){window.$memberstackDom&&$memberstackDom.getCurrentMember?$memberstackDom.getCurrentMember().then(t=>{let r=t?.data?.id||"";r&&sessionStorage.setItem("domofen_msid",r),e(r)}).catch(()=>this.fallbackV1(e)):this.fallbackV1(e)},fallbackV1(e){window.MemberStack&&window.MemberStack.onReady?window.MemberStack.onReady.then(t=>{let r=t?.member?.id||"";r&&sessionStorage.setItem("domofen_msid",r),e(r)}).catch(()=>e("")):e("")},runPrefill(e,r){n(this.form,"member_stack_id",r||""),fetch(t.PREFILL_URL+"?rec="+encodeURIComponent(e),{method:"GET",headers:{"x-member-id":r||""}}).then(e=>{if(!e.ok)throw Error("HTTP "+e.status);return e.json()}).then(e=>this.applyPrefillToForm(e)).catch(e=>console.error("[Prefill] fetch error",e))},applyPrefillToForm(e){let t=e&&"object"==typeof e.fields?e.fields:{};Object.keys(t).forEach(e=>{let r=this.form.querySelector('[name="'+e+'"]');if(!r)return;let i=t[e];if("checkbox"===r.type)this.setCheckbox(r,i);else if("radio"===r.type)this.setRadio(e,i);else if("SELECT"===r.tagName){let n=!1;if(r.querySelector('option[value="'+i+'"]')&&(r.value=String(i),n=!0),!n){let o=Array.from(r.options).find(e=>a(e.textContent)===a(i));o&&(r.value=o.value,n=!0)}n||(r.value=String(i)),r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}else{if(null!=i&&"object"==typeof i)try{r.value=JSON.stringify(i)}catch(s){r.value=String(i)}else r.value=i??"";r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}});try{let r=t.positions_json;if(r){let i="string"==typeof r?JSON.parse(r):r;Array.isArray(i)&&window.__domofenHydratePositions&&window.__domofenHydratePositions(this.form,i)}if(void 0!==t.positions_count){let n=this.form.querySelector('[name="positions_count"]');n&&(n.value=String(t.positions_count))}}catch(o){console.warn("[Prefill] positions_json parse error",o)}this.form.querySelectorAll('input[type="radio"]:checked').forEach(e=>{e.dispatchEvent(new Event("change",{bubbles:!0}))});let s=()=>{this.form.querySelectorAll('input[type="checkbox"]').forEach(e=>{let t=e.closest(".w-checkbox")?.querySelector(".w-checkbox-input");t&&(e.checked?t.classList.add("w--redirected-checked"):t.classList.remove("w--redirected-checked"));let r=e.closest(".w-checkbox");r&&r.setAttribute("aria-checked",e.checked?"true":"false")})};s(),setTimeout(s,50),setTimeout(s,150),setTimeout(s,300),document.dispatchEvent(new CustomEvent("prefill:applied",{detail:{fields:t}})),window.__domofen_last_fields=t},setCheckbox(e,t){e.checked=(e=>{if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e||"1"===e)return!0;if(0===e||"0"===e)return!1;let t=String(e).toLowerCase().trim();return!["","false","non","no","off","null","undefined","n"].includes(t)&&(!!["true","oui","yes","on","vrai","y","checked"].includes(t)||t.length>0)})(t),s(e),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))},setRadio(e,t){var r;let i=Array.from(this.form.querySelectorAll('input[type="radio"][name="'+e+'"]'));if(!i.length)return!1;let n=a(null==t?"":String(t)),o=new Set(["1","true","oui","yes","vrai","on"]),l=new Set(["0","false","non","no","off","faux"]),d=i.find(e=>a(e.value)===n);return!!(d||(d=i.find(e=>{let t=e.closest(".w-radio")?.querySelector("label");return t&&a(t.textContent)===n}))||(o.has(n)||l.has(n))&&((d=i.find(e=>o.has(n)?o.has(a(e.value)):l.has(a(e.value))))||(d=i.find(e=>{let t=e.closest(".w-radio")?.querySelector("label"),r=t?a(t.textContent):"";return o.has(n)?r.includes("oui")||o.has(r):r.includes("non")||l.has(r)})),d))&&(i.forEach(e=>{e.checked=!1,s(e)}),(r=d).checked=!0,s(r),r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0})),!0)},initHydration(){let e=(e,t,r)=>{let i=e.querySelector('[name="'+t+'"]');if(!i)return!1;if("checkbox"===i.type)this.setCheckbox(i,r);else if("radio"===i.type)this.setRadio(t,r);else if("SELECT"===i.tagName){let n=!1;if(i.querySelector('option[value="'+r+'"]')&&(i.value=String(r),n=!0),!n){let o=Array.from(i.options).find(e=>a(e.textContent)===a(r));o&&(i.value=o.value,n=!0)}n||(i.value=String(r)),i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}else i.value=null!=r&&"object"==typeof r?JSON.stringify(r):r??"",i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}));return!0},t=()=>document.querySelectorAll(".js-position").length;window.__domofenHydratePositions=(i,a)=>{if(!Array.isArray(a)||0===a.length)return;let n=r("#btn-add-position");for(;t()<a.length&&n;)n.click();for(;t()>a.length;){let o=document.querySelectorAll(".js-position"),s=o[o.length-1];s&&s.remove()}a.sort((e,t)=>(e.index||0)-(t.index||0)).forEach((t,r)=>{let a=r+1,n=document.querySelector('.js-position[data-pos="'+a+'"]')||(()=>{let e=document.querySelectorAll(".js-position");return e.length?e[e.length-1]:null})();if(!n)return;Object.keys(t).forEach(r=>{"index"!==r&&"schema"!==r&&e(i,"pos_"+a+"__"+r,t[r])});let o=t.schema?.id||"",s=t.schema?.url||"",l=t.schema?.name||"";if(e(i,"pos_"+a+"__schema_id",o),e(i,"pos_"+a+"__schema_url",s),e(i,"pos_"+a+"__schema_name",l),s){let d=n.querySelector(".schema-picker"),c=n.querySelector("img.schema-thumb-img"),u=n.querySelector(".schema-plus"),m=d?.querySelector(".schema-name");d?.querySelector(".icon-schema"),c&&(c.src=s,c.style.opacity="1"),u&&(u.style.opacity="0"),l&&m&&(m.textContent=l,d&&d.classList.add("has-schema"))}}),setTimeout(()=>{a.forEach((e,t)=>{let r=e.schema?.name||"",i=e.schema?.url||"";if(i&&r){let a=document.querySelector('.js-position[data-pos="'+(t+1)+'"]');if(!a)return;let n=a.querySelector(".schema-picker"),o=n?.querySelector(".schema-name");o&&!o.textContent&&(o.textContent=r,n&&n.classList.add("has-schema"))}})},500);let l=i.querySelector('[name="positions_json"]'),d=i.querySelector('[name="positions_count"]');l&&(l.value=JSON.stringify(a)),d&&(d.value=String(a.length))}}},y={form:null,init(e){this.form=e;let t=()=>{let e=this.findDraftButton();e?("A"===e.tagName&&(e.setAttribute("href","#"),e.setAttribute("role","button")),e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.save(e)}),console.log("[Draft] ready")):console.warn("[Draft] bouton introuvable")};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()},findDraftButton:()=>r("#btn-save-draft")||r('[data-action="save-draft"]')||Array.from(document.querySelectorAll("a,button")).find(e=>/enregistrer le brouillon/i.test(e.textContent||"")),valAny(e){for(let t of e){let r=this.form.querySelector('[name="'+t+'"]');if(r){if("radio"===r.type){let i=this.form.querySelector('input[type="radio"][name="'+t+'"]:checked');if(i)return i.value;continue}if("checkbox"===r.type)return r.checked?"true":"false";if(void 0!==r.value&&""!==r.value)return r.value}}return""},get(e){let t=this.form.querySelector('[name="'+e+'"]');return t?t.value:""},getTextContent(e){let t=document.querySelector(e);return t?(t.textContent||"").trim():""},ensurePositionsSerialized(){let e=this.form.noValidate,t=this.form.hasAttribute("novalidate");this.form.noValidate=!0,t||this.form.setAttribute("novalidate","");try{let r=new Event("submit",{bubbles:!0,cancelable:!0});this.form.dispatchEvent(r)}catch(i){}return this.form.noValidate=e,t||this.form.removeAttribute("novalidate"),{positions_json:this.get("positions_json")||"",positions_count:this.get("positions_count")||""}},rewriteUrlWithRec(e){try{if(!e)return;let t=new URL(location.href);t.searchParams.get("rec")!==String(e)&&(t.searchParams.set("rec",String(e)),history.replaceState(null,"",t.toString()));let r=this.form.querySelector('[name="airtable_record_id"]');r||((r=document.createElement("input")).type="hidden",r.name="airtable_record_id",this.form.appendChild(r)),r.value=String(e),sessionStorage.setItem("domofen_rec",String(e)),this.form.dataset.mode="update"}catch(i){console.warn("[Draft] rewriteUrlWithRec error",i)}},buildPayload(){let e=new URLSearchParams(location.search||""),t=this.form.id||this.form.getAttribute("name")||"",r=e.get("flow")||this.get("workflow_action")||"demande",i=this.valAny(["airtable_record_id","record_id"])||e.get("rec")||"",a=this.valAny(["webflow_item_id","webflow-id","webflow_item","webflowId"])||e.get("item")||"",n=this.valAny(["member_stack_id","memberstack_id"])||sessionStorage.getItem("domofen_msid")||"",o=this.ensurePositionsSerialized(),s=o.positions_json||"",l=o.positions_count||"",d=[];try{d=s?JSON.parse(s):[]}catch(c){}return{action:"draft",etat:"Brouillon",form_id:t,workflow_action:r,airtable_record_id:i,webflow_item_id:a,member_stack_id:n,rec:i,item:a,positions_json:s,positions_count:l,positions:d,meta:{form_id:t,submitted_at:"",offer_or_demand:"",submission_id:"",page_id:"",page_url:location.href||"",published_path:""},memberstack:{email:this.valAny(["ms_email"])||this.getTextContent("#ms_email_txt"),first_name:this.valAny(["ms_first_name"])||this.getTextContent("#ms_first_txt"),last_name:this.valAny(["ms_last_name"])||this.getTextContent("#ms_last_txt"),company:this.valAny(["ms_company"])||this.getTextContent("#ms_company_txt"),adresse:this.valAny(["ms_adresse"])||this.getTextContent("#ms_adresse_txt")},entreprise:{responsable_du_dossier:this.valAny(["responsable-du-dossier","responsable_du_dossier"]),adresse_email_de_retour:this.valAny(["email-adresse-de-retour","Email-retour-different"]),question_adresse_livraison_differente:this.valAny(["question_adresse_livraison_differente","autre-adresse-livraison","autre-adresse-livraison?","autre_adresse_livraison"]),autre_adresse_livraison:this.valAny(["autre_adresse_de_livraison","autre_adresse_livraison"]),autre_adress_npa:this.valAny(["autre_adress_npa"]),autre_adress_localite:this.valAny(["autre_adress_localite"])},chantier:{reference:this.valAny(["Reference","ref_demande"]),type_chantier:this.valAny(["Type de chantier","Type-de-chantier"]),type_bien:this.valAny(["Type de bien","Type-de-bien"]),adresse_chantier:this.valAny(["Adress_chantier","Adresse chantier","Adresse chantier*","Adresse de livraison"]),npa:this.valAny(["NPA"]),localite:this.valAny(["Localit\xe9","Localit","chantier_localite"])},choix:{couleur_interieur:this.valAny(["couleur_interieur"]),couleur_exterieur:this.valAny(["couleur_exterieur"]),couleur_intercalaire:this.valAny(["couleur_intercalaire"]),couleur_ame_profil:this.valAny(["couleur_ame_profil"]),type_de_soudure:this.valAny(["type de soudure","type-de-soudure"]),verres:this.valAny(["choix-des-verres"]),verres_autre:this.valAny(["vitrage_autre","Vitrage – autre"]),altitude:this.valAny(["Altitude","altitude"]),delignement:this.valAny(["D\xe9lignement","D-lignement"]),securite:this.valAny(["securite","S\xe9curit\xe9"]),renvoie_eau:this.valAny(["Renvoie deau","Renvoie-d-eau"]),cale_15x21:this.valAny(["Cale 15x21 mm","Cale-15x21-mm"]),cale_21x15:this.valAny(["Cale 21x15 mm","Cale-21x15-mm"]),donnee_de_dimension:this.valAny(["donnee de dimension","donnee_de_dimension"]),fermente_invisible:this.valAny(["Fermente invisible","Fermente-invisible"]),clip_reno_111033:this.valAny(["Clip Reno 111033","Clip-Reno-111033"])},options:{renvoie_eau:this.valAny(["Renvoie deau","Renvoie-d-eau"]),trous_de_fixations:this.valAny(["Trous-de-fixations","Trous de fixations","trous_de_fixations"]),pattes_de_fixations:this.valAny(["Pattes-de-fixations","Pattes de fixations","pattes_de_fixations"]),cale_15x21:this.valAny(["Cale 15x21 mm","Cale-15x21-mm"]),cale_21x15:this.valAny(["Cale 21x15 mm","Cale-21x15-mm"]),donnee_de_dimension:this.valAny(["donnee de dimension","donnee_de_dimension"]),fermente_invisible:this.valAny(["Fermente invisible","Fermente-invisible"]),clip_reno_111033:this.valAny(["Clip Reno 111033","Clip-Reno-111033"])},remarque_general:{remarques:this.valAny(["remarques-generales","Remarques g\xe9n\xe9rales"])},pieces_jointes:{domofen_upload:this.valAny(["DomofenOfficiel","Document_upload"])}}},save(e){let r=this.form.querySelector("#Reference")||this.form.querySelector('[name="Reference"]');if(r){if(!(r.value||"").trim()){r.setCustomValidity("Le champ R\xe9f\xe9rence est obligatoire avant de sauvegarder votre brouillon"),r.reportValidity(),r.addEventListener("input",function e(){r.setCustomValidity(""),r.removeEventListener("input",e)});return}r.setCustomValidity("")}let i=Array.from(this.form.querySelectorAll("[required]"));i.forEach(e=>e.removeAttribute("required"));let a=this.buildPayload();e.disabled=!0,setTimeout(()=>{i.forEach(e=>e.setAttribute("required",""))},100),fetch(t.SAVE_DRAFT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(async e=>{let t=await e.text(),r={};try{r=t?JSON.parse(t):{}}catch(i){console.warn("[Draft] JSON parse error",t)}return{ok:e.ok,status:e.status,json:r}}).then(({ok:e,json:t})=>{console.log("[Draft] response",t);let r=t&&(t.rec||t.record_id||t.airtable_record_id);r&&this.rewriteUrlWithRec(String(r)),alert(e?"Brouillon enregistr\xe9.":"Impossible d'enregistrer le brouillon.")}).catch(e=>{console.error("[Draft] error",e),alert("Impossible d'enregistrer le brouillon pour le moment.")}).finally(()=>{e.disabled=!1})}},v={init(e){if(!e)return;let t=t=>{let r=e.querySelector('input[type="hidden"][name="'+t+'"]');return r||((r=document.createElement("input")).type="hidden",r.name=t,e.appendChild(r)),r},r=e.querySelector('input[name="autre_adresse_de_livraison"]'),i=e.querySelector('input[name="autre_adress_npa"]'),a=e.querySelector('input[name="autre_adress_localite"]'),n=t("autre_adresse_de_livraison_mirror"),o=t("autre_adress_npa_mirror"),s=t("autre_adress_localite_mirror"),l=(e,t)=>{e&&(t.value=e.value||"")},d=()=>{l(r,n),l(i,o),l(a,s)};[r,i,a].forEach(e=>{e&&(e.addEventListener("input",d),e.addEventListener("change",d))}),document.addEventListener("prefill:applied",d),document.addEventListener("DOMContentLoaded",d),e.addEventListener("submit",d,!0)}};e.DomofenForms={init(e={}){let i=e.flow||"demande";l.init(),d.init(),c.init(),u.init(),m.init(),h.init(),p.init();let a=(()=>{for(let e of t.FORM_SELECTORS){let i=r(e);if(i)return i}return null})();a?(f.init(a,i),y.init(a),v.init(a),console.log("[DomofenForms] initialized with flow:",i)):console.error("[DomofenForms] Form not found")}}}("undefined"!=typeof window?window:this);
